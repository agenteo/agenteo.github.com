<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title> GIT precommit hooks helping local Ruby GEMs development |  Enrico Teotti, Agent</title>

    <link rel="stylesheet" href="/stylesheets/styles.css">
    <link rel="stylesheet" href="/stylesheets/pygment_trac.css">

    <!-- bxSlider CSS file -->
    <link href="/stylesheets/jquery.bxslider.css" rel="stylesheet" />

    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- jQuery library (served from Google) -->
    <script src="/javascripts/jquery-2.0.0.min.js"></script>
    <!-- bxSlider Javascript file -->
    <script src="/javascripts/jquery.bxslider.min.js"></script>

    <script>
    $(document).ready(function(){
      $('.bxslider').bxSlider();
    });
    </script>

  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1><a href="/">Enrico Teotti</a></h1>
        <img src="/images/me/deep_sea_diver.jpg" style="border: 1px solid white; border-radius: 30px; -moz-border-radius: 30px; -khtml-border-radius: 30px; -webkit-border-radius: 30px;" alt="Halloween, me in my homemade deep sea diver costume"/>
        <p class="view"><a href="https://github.com/agenteo">View My GitHub Profile</a></p>

        
      </header>
      <section>
      <h1 id="git-precommit-hooks-helping-local-ruby-gems-development">GIT precommit hooks helping local Ruby GEMs development</h1>

<p>I was working on a Ruby app that depended on a few private gems, the development workflow was changing not just the app but also those gems.</p>

<p>During development the <code>Gemfile</code> would look like:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">cargo_estimates</span><span style="color:#710">'</span></span>, <span style="color:#606">path</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">local_engines/cargo_estimates</span><span style="color:#710">'</span></span>
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">shipping_calculator</span><span style="color:#710">'</span></span>, <span style="color:#606">path</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">local_engines/shipping_calculator</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Running bundle would set the <code>Gemfile.lock</code> to those gem local version. Goes without saying that committing that <code>Gemfile.lock</code> in version control could have disastrous consequences.</p>

<p>Once the gems are updated and published the fix would be as easy as manually change the <code>Gemfile</code> to:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">cargo_estimates</span><span style="color:#710">'</span></span>
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">shipping_calculator</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>What I came up with is a unix environment variable to switch on local or remote development:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">if</span> <span style="color:#069">ENV</span>[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">LOCAL_ENGINES</span><span style="color:#710">'</span></span>]
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">cargo_estimates</span><span style="color:#710">'</span></span>, <span style="color:#606">path</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">local_engines/cargo_estimates</span><span style="color:#710">'</span></span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>  gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">shipping_calculator</span><span style="color:#710">'</span></span>, <span style="color:#606">path</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">local_engines/shipping_calculator</span><span style="color:#710">'</span></span>
<span class="line-numbers"><a href="#n4" name="n4">4</a></span><span style="color:#080;font-weight:bold">else</span>
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>  gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">cargo_estimates</span><span style="color:#710">'</span></span>
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>  gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">shipping_calculator</span><span style="color:#710">'</span></span>
<span class="line-numbers"><a href="#n7" name="n7">7</a></span><span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<h2 id="development-bootstrap">Development bootstrap</h2>

<p>In my project folder I had a <code>dev_bootstrap.sh</code> calling a set of script located in <code>PROJECT_DIRECTORY/dev_bootstrap_scripts</code> to automate the local development setup:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>#!/bin/bash
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>./dev_bootstrap_scripts/precommit_hooks.sh
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>./dev_bootstrap_scripts/local_engines.sh
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>./dev_bootstrap_scripts/set_rvmrc.sh
</pre></div>
</div>
</div>

<p>First setup the local engines by creating a local folder and checking out the repositories from <code>dev_bootstrap_scripts/local_engines.sh</code>:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>#!/bin/bash
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>DIR=local_engines
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>mkdir $DIR
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>git clone git@github.com:worldwide_shipping/cargo_estimates.git $DIR/cargo_estimates
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>git clone git@github.com:worldwide_shipping/shipping_calculator.git $DIR/shipping_calculator
</pre></div>
</div>
</div>

<p>Second, link up the git precommit hooks in <code>dev_bootstrap_scripts/precommit_hooks.sh</code>:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>#!/bin/bash
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>ln -s ../../pre_commit.sh .git/hooks/pre-commit
</pre></div>
</div>
</div>

<p>Third and final set the ENV variable via rvmrc in <code>dev_bootstrap_scripts/set_rvmrc.sh</code>:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span>echo &quot;rvm use $(cat .ruby-version)&quot; &gt; .rvmrc
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>echo &quot;export LOCAL_ENGINES=true&quot; &gt;&gt; .rvmrc
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>echo &quot;!!!! MANUAL STEP REQUIRED !!!!&quot;
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>echo &quot;==&gt; You need to use the correct rvm environment. Run:&quot;
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>echo &quot;source .rvmrc'&quot;
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>echo &quot;~~~~&quot;
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>I used the `.ruby-version` to generate the `.rvmrc` which will be executed automatically when you enter the project directory and setup the `LOCAL_ENGINES` to true. The `.rvmrc` must be in your `.gitignore`.
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>An alternative to use `.rvmrc` would be to run `LOCAL_ENGINES=true bundle`, in fact I had a script `lebundle.sh` to facilitate that:
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>~~~bash
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>#!/bin/bash
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>export LOCAL_ENGINES=true
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>bundle
</pre></div>
</div>
</div>

<p>One problem using the <code>.rvmrc</code> solution is you need to <code>unset LOCAL_ENGINES</code> when you want to bundle your application for production.</p>

<h2 id="precommit-hook">Precommit hook</h2>

<p>Inside <code>pre_commit_scripts/no_local_engines_in_gemfile_lock.sh</code> you can see how I use <code>grep</code> to locate the string <code>PATH</code> in my <code>Gemfile.lock</code> indicating a local gem is being used. </p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span>#!/bin/bash
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>grep &quot;PATH&quot; Gemfile.lock &gt; /dev/null
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>if [ $? = 0 ]; then
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>  echo &quot;==&gt; WARNING&quot;
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>  echo &quot;==  You have a PATH in your Gemfile.lock! That usually mean that some gems are local to the project!&quot;
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>  echo &quot;***&quot;
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>  echo &quot;If you are sure this is what you want you can bypass precommits with 'git commit --no-verify'&quot;
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>  echo &quot;If the local engines are there because you where developing them, you should run 'bundle' to update Gemfile.lock.&quot;
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>  echo &quot;with the correct dependencies location.&quot;
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>  echo &quot;***&quot;
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>  exit 1
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>fi
</pre></div>
</div>
</div>

<h2 id="summary">Summary</h2>

<p>This worked for me cause I didn’t have any local engines when the project was deployed to production. If you have a mix of local and remote gems you will have to come up with a smart regular expression knowledgeable of which dependency is allowed as a local gem.</p>

<p>I looked in to git server side hooks (http://git-scm.com/book/en/Customizing-Git-Git-Hooks#Server-Side-Hooks) but hosted version control (github or bitbucket) allow you to run custom scripts.</p>

<p>So precommit git client side hooks require an initial bootstrap step but are a really great tool to facilitate development workflow. If you work with local gems I’d like to hear about your workflow in the comments.</p>

<div id="disqus_thread"></div>
<script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'enricoteotti'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<p><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></p>


      </section>
      <footer>
        <p><small>Hosted on the Plant Mars</p>
      </footer>
    </div>
    <script src="/javascripts/scale.fix.js"></script>

  </body>
</html>

