<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Feature flagging portions of your Ruby on Rails application with engines</title>
  <meta name="description" content="I craft maintainable software that delivers business value. Born and educated in Italy, became Australian now working in New York City.
" />

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="canonical" href="http://teotti.com//feature-flagging-portions-of-your-ruby-on-rails-application-with-engines/">

  <link rel="shortcut icon" href="/assets/images/favicon.ico">
<!--  <link rel="stylesheet" href=""> -->
  <link rel="stylesheet" href="http://brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-57294014-1', 'auto');
    ga('send', 'pageview');

  </script>
</head>

  <meta property="og:title" content="Feature flagging portions of your Ruby on Rails application with engines" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="In the past I used Rails engines to create smaller components in complex Rails applications with the objective of a better long term maintainability. What that usually means is I separate out user interface engines from domain logic engines. For the last two months I've been working on a greenfield..." />
  <script data-cfasync="false" type="text/javascript" src="//filamentapp.s3.amazonaws.com/d44553ac52ef97f2dbdb691fbfa3383d.js" async="async"></script>

  <body itemscope itemtype="http://schema.org/Article">
    <!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-54d976e32f0ec904" async="async"></script>

    <!-- header start -->

<a href="http://teotti.com/" class="logo-readium"><span class="logo" style="background-image: url(/assets/images/beach.jpg)"></span></a>

<!-- header end -->

    <main class="content" role="main">
      <article class="post">
        
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">Feature flagging portions of your Ruby on Rails application with engines</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person"></h4>
              on
              <time datetime="2014-08-04T00:00:00-04:00">04 Aug 2014</time>
              <!-- , tagged on <span class="post-tag-">, <a href="/tag/"></a></span> -->
            </div>
          </div>
        </div>
        <br>
        <br>
        <br>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>In the past I used Rails engines to create smaller components in complex Rails applications with the objective of a better long term maintainability. What that usually means is I separate out user interface engines from domain logic engines.</p>

<p>For the last two months I’ve been working on a greenfield project with a public and administration interface both living in the same application.</p>

<p>Recently I was asked to break up the public part from the administration part of a web application because of a company policy to lock administration interfaces behind a VPN. Other points that were brought up: to separate the load between the two portions, and to reduce admin deployments disrupting service on the public portion.</p>

<h2 id="first-proposal">First proposal</h2>

<p>An initial proposal was to split it in two applications and have them talking via an API. That service oriented architecture seemed very much premature optimization since nothing else was going to use the API. Also the two portions of the app (public and admin) would have to share a significant amount of domain logic (to access the data models) and user interface (to allow staff members to preview elements as they will look on public).</p>

<h2 id="second-proposal">Second proposal</h2>

<p>Another solution was to separate the shared domain logic and user interface in to Rails engines, and have the two portions (public and admin) depend on them. The downside of this was dealing with local dependencies while in development mode.</p>

<p>We knew our development would constantly alter the domain logic engine and the shared ui engine, meaning releasing a new gem for every admin or public update. We would also have to <a href="/git-precommit-hooks-helping-local-ruby-gems-development/">update our work flow</a> to ensure the Gemfile.lock won’t be pointing to the local gems when checked in version control.</p>

<h2 id="final-proposal">Final proposal</h2>

<p>Instead why not keep the application as one, and switch the admin interface and public interface on or off based on an application <em>running mode</em> feature flag?</p>

<p>In order to do this, both <em>admin_ui</em> and <em>public_ui</em> are Rails engines and the main application mounts them based on a unix environment variable.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
<span class="k">case</span> <span class="no">AppRunningMode</span><span class="o">.</span><span class="n">value</span>
  <span class="k">when</span> <span class="ss">:admin</span>
    <span class="n">mount</span> <span class="no">AdminUi</span><span class="o">::</span><span class="no">Engine</span> <span class="o">=&gt;</span> <span class="s2">&quot;/admin&quot;</span>
  <span class="k">when</span> <span class="ss">:public</span>
    <span class="n">mount</span> <span class="no">PublicUi</span><span class="o">::</span><span class="no">Engine</span> <span class="o">=&gt;</span> <span class="s2">&quot;/&quot;</span>
  <span class="k">else</span>
    <span class="n">mount</span> <span class="no">AdminUi</span><span class="o">::</span><span class="no">Engine</span> <span class="o">=&gt;</span> <span class="s2">&quot;/admin&quot;</span>
    <span class="n">mount</span> <span class="no">PublicUi</span><span class="o">::</span><span class="no">Engine</span> <span class="o">=&gt;</span> <span class="s2">&quot;/&quot;</span>
<span class="k">end</span></code></pre></div>

<p>The class method <code>AppRunningMode.value</code> is just a proxy to the env variable.</p>

<p>So you can then run the application public portion with:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">RUNNING_MODE</span><span class="o">=</span>public rails s</code></pre></div>

<p>and run the admin portion with:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">RUNNING_MODE</span><span class="o">=</span>admin rails s</code></pre></div>

<p>One of the advantages of this approach is you can run in development mode without that variable and both portions will be mounted.</p>

<p>EDIT: reduce memory footprint creating a bundle group for the running mode to require only what is needed. <a href="http://teotti.com/2015-01-27-reduce-memory-footprint-requiring-portions-of-your-component-based-rails-applications">Read more here</a>.</p>

<p>It will be likely be part of the server provisioning process to setup that ENV variable.</p>

<p>The main application Gemfile will still include both engines:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">&#39;domain_logic&#39;</span><span class="p">,</span> <span class="ss">path</span><span class="p">:</span> <span class="s1">&#39;engines/domain_logic&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;shared_ui&#39;</span><span class="p">,</span> <span class="ss">path</span><span class="p">:</span> <span class="s1">&#39;engines/shared_ui&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;admin_ui&#39;</span><span class="p">,</span> <span class="ss">path</span><span class="p">:</span> <span class="s1">&#39;engines/admin_ui&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;public_ui&#39;</span><span class="p">,</span> <span class="ss">path</span><span class="p">:</span> <span class="s1">&#39;engines/public_ui&#39;</span></code></pre></div>

<p>EDIT: you can group your engines and avoid listing the transitive dependencies. <a href="http://teotti.com/gemfiles-hierarchy-in-ruby-on-rails-component-based-architecture/">Read more</a></p>

<p>So the engines are all there, and if you have a <code>raise 'boom'</code> in your <code>admin_ui/lib/admin_ui.rb</code> even when the app running mode is set to public <em>will</em> explode. This unrealistic example is a reminder that this is a single application. Hopefully your test suite will catch that raise.</p>

<p>In regards to the rails engines approach both AdminUi and PublicUi depend on a DomainLogic engine and a SharedUi engine. This facilitate a complete split of the two portions in the future without locking you in to any specific architecture today.</p>

<h2 id="summary">Summary</h2>
<p>I think this approach is pragmatic and delivers what we need now allowing up to adapt if in the future we will need a different architecture.</p>

<p>If you had to split portions of your applications on different servers I’d like to hear your approach. If you have any question feel free to use the comments.</p>

<p>UPDATE: a video of a talk I gave about this at NYC.rb is available on <a href="https://www.youtube.com/watch?v=rMOn2H7h3oY">https://www.youtube.com/watch?v=rMOn2H7h3oY</a></p>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=Feature+flagging+portions+of+your+Ruby+on+Rails+application+with+engines&amp;url=http://teotti.com//feature-flagging-portions-of-your-ruby-on-rails-application-with-engines"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <h4>Enrico Teotti</h4>
              <p class="bio"></p>
              <hr>
              <p class="published">Published <time datetime="2014-08-04 00:00">04 Aug 2014</time></p>
              <p><a class="subscribe" href="/feed.xml"> <span class="tooltip"> <i class="fa fa-rss"></i> subscribe to the feed</span></a></p>
            </section>
          </div>
          
          <div class="isRight">
            <h5 class="index-headline featured"><span>Related posts</span></h5>
<footer class="site-footer">
  <ul>
    
    <li><a href="/create-maintainable-mongodb-queries-in-ruby-with-query-object-and-mongoid-criterias/">Create maintainable mongodb queries in Ruby with query object and mongoid criterias</a></li>
    
    <li><a href="/reduce-memory-footprint-requiring-portions-of-your-component-based-rails-applications/">Reduce memory footprint requiring portions of your component based Rails application with Bundler</a></li>
    
    <li><a href="/one-url-segment-serving-different-resources-with-ruby-on-rails-route-constraints/">One URL segment serving different resources with Ruby on Rails route constraints</a></li>
    
    <li><a href="/ignore-query-strings-in-ruby-on-rails-caching-with-rack-cache/">Ignore query strings in Ruby on Rails caching with rack-cache</a></li>
    
    <li><a href="/building-intention-revealing-ruby-on-rails-helpers/">Building intention revealing Ruby on Rails helpers</a></li>
    
  </ul>
  <div class="inner">
    <section class="copyright">All content copyright <a href="/">Enrico Teotti</a> &copy; 2014<br>All rights reserved.</section>
  </div>
</footer>

          </div>
        </div>
        
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'enricoteotti'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </article>
    </main>
    <div class="bottom-closer">
      <div class="background-closer-image"  style="background-image: url(/assets/images/background_image.jpg)">
        Image
      </div>
      <div class="inner">
        <h1 class="blog-title">今日は, I am Enrico</h1>
        <h2 class="blog-description">I craft maintainable software that delivers business value. Born and educated in Italy, became Australian now working in New York City.
</h2>
        <a href="/" class="btn">Back to Overview</a>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    $window.on('scroll', function() {
      var top = $window.scrollTop();

      if (top < 0 || top > 1500) { return; }
      $image
        .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
        .css('opacity', 1-Math.max(top/700, 0));
    });
    $window.trigger('scroll');

    var height = $('.article-image').height();
    $('.post-content').css('padding-top', height + 'px');

    $('a[href*=#]:not([href=#])').click(function() {
      if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
       && location.hostname == this.hostname) {
        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
        if (target.length) {
          $('html,body').animate({ scrollTop: target.offset().top }, 500);
          return false;
        }
      }
    });
  });
}(jQuery));
</script>


  </body>
</html>
